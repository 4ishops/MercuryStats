Меркурий 200.02 <-> CAN(RS485)
==

Электросчетчик [Меркурий](http://www.incotexcom.ru/m200.htm) имеет CAN-интерфейс для внешнего управления.  

Скрипт **mercury200-sendcmd.php** позволяет отправлять команды электросчетчику и считывать ответы с него. Протокол обмена производитель свободно не распространяет. Ниже наработки по его реверсингу.   
В *examples* пример cкрипта для получения параметров электросети(напряжение,ток,мошность нагрузки) и отправки их на [Xively](https://xively.com/feeds/19249442) для построениz графиков. 
[Пример web-интерфейса для просмотра параметров электросчетчика](http://goo.gl/kQaoDC).

Протокол обмена "Меркурий 200"
==
Для обращения к электросчетчику необходимо знать его адрес. Для модели 200.02 это последние 6 цифр серийного номера. В моем случае это `411486` в десятичном представлении либо `06 47 5E` в hex

### Формат фрейма запрос

Стартовый байт | Адрес счетчика | Запрос | CRC16 (Modbus)
:---: | :---: | :---: | :---: 
*1 байт* | *3 байта* | *1 байт* | *2 байта*
`00` | `06 47 5E` 

### Формат фрейма ответа

Стартовый байт| Адрес счетчика | Запрос<br>(на который отвечаем) | Ответ | [CRC16 (Modbus)](http://www.php.net/manual/ru/function.crc32.php#64127)
 :---: | :---: | :---: | :---: | :---: 
*1 байт* | *3 байта* | *1 байт* | |*2 байта*
`00` | `06 47 5E` | 

### Запросы и Ответы

Запрос<br>(hex) |  Описание команды |  Ответ
 :------------: | :---------------- | ---------------
`21` | Текущая дата и время
`22` | Лимит мощности | 99990 Вт
`23` | Лимит энергии | 9999 квт*ч
`24` | Флаг перехода зимнее.летнее
`25` | Флаг разрешения коррекции<br>времени кнопками   
`26` | Чтение мощности   
`27` | Значение энергии | *[16 байт]*<br>[4] Тариф1<br>[4] Тариф2<br>[4] Тариф3<br>[4] Тариф4<br><br>Результат в (кВт*ч)*100
`28` | Версия | байт версии, байт подверсии
`29` | Напряжение встроенной батарейки | *[2 байта]*<br>[1] Единицы Вольт<br>[1] Десятые доли Вольт
`2A` | Индикация на дисплее
`2B` | Служебная информация                           
`2C` | Служебная информация 
`2D` | Функция испульсного выхода чтение
`2F` | Служебная информация    
`31` | Тарифное расписание                          
`63` | Текущие параметры электросети  | *[7 байт]*<br>[2] Напряжение в Вольт*10<br>[2] Ток в Ампер*100<br>[3] Мощность в Ваттах                                              
`65` | Служебная информация    
`66` | Дата изготовления | *[2 байта]*<br>[1] день<br>[1] месяц<br>[1] год
`67` | Индикация на дисплее                           
`87` | Служебная информация                         


### Примеры
*Чтение параметров электросети*  
Запрос: `00` `06 47 5E` `63` `EC D4`  
Ответ:  `00` `06 47 5e` `63` `23 58` `02 64` `00 05 88` `45c6`  
235,8 Вольт; 2,64 Ампера; 588 Ватт  

*Чтение накопленная энергии*  
Запрос: `00` `06 47 5E` `27` `ECE7`  
Ответ:  `00` `06 47 5E` `27` `00062142` `00020834` `00000000` `00000000` `59F5`  
621,42 кВт*ч(Т1); 208,34 кВт*ч(Т2);  0 кВт*ч(Т3); 0 кВт*ч(Т4)  

### Ссылки
- http://incotex-counter.blogspot.ru/2011/03/can-rs485.html
- http://www.ab-log.ru/smart-house/mercury-230
- https://github.com/sergray/energy-meter-mercury206
